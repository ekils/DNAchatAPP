
<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" />
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css" />
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
{#<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>#}
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
{#angularjs#}
<script src=" https://ajax.googleapis.com/ajax/libs/angularjs/1.7.2/angular.min.js"></script>
{#<script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>#}
{#google icon: #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!------ Include the above in your HEAD tag ---------->

<!DOCTYPE html><html class=''>
{#<head><script src='//production-assets.codepen.io/assets/editor/live/console_runner-079c09a0e3b9ff743e39ee2d5637b9216b3545af0de366d4b9aad9dc87e26bfd.js'></script><script src='//production-assets.codepen.io/assets/editor/live/events_runner-73716630c22bbc8cff4bd0f07b135f00a0bdc5d14629260c3ec49e5606f98fdd.js'></script><script src='//production-assets.codepen.io/assets/editor/live/css_live_reload_init-2c0dc5167d60a5af3ee189d570b1835129687ea2a61bee3513dee3a50c115a77.js'></script><meta charset='UTF-8'><meta name="robots" content="noindex"><link rel="shortcut icon" type="image/x-icon" href="//production-assets.codepen.io/assets/favicon/favicon-8ea04875e70c4b0bb41da869e81236e54394d63638a1ef12fa558a4a835f1164.ico" /><link rel="mask-icon" type="" href="//production-assets.codepen.io/assets/favicon/logo-pin-f2d2b6d2c61838f7e76325261b7195c27224080bc099486ddd6dccb469b8e8e6.svg" color="#111" /><link rel="canonical" href="https://codepen.io/michellelpepe/pen/GoQyoJ?depth=everything&order=popularity&page=84&q=pack&show_forks=false" />#}
{#<link href='https://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>#}

<head>

<style class="cp-pen-styles" >* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Nunito', sans-serif;
}


html, body {
    background: linear-gradient(15deg, #997D37 ,#2a7561,#18594B,#115146 );
    background-size: cover;
  {#background: -webkit-linear-gradient(330deg, #000, #f0a6ca);#}
  {#background: linear-gradient(120deg, #000, #f0a6ca);#}
    overflow: hidden;
}

.modalinline{
    display:inline;
}


{#////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////#}


{#like #frame#}
.container {
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-pack: center;
  -ms-flex-pack: center;
  justify-content: center;
  -webkit-box-align: center;
  -ms-flex-align: center;
  align-items: center;
  -webkit-box-orient: vertical;
  -webkit-box-direction: normal;
  -ms-flex-direction: column;
  flex-direction: column;
  height: 90%;
  width: 100vw;

}

.container h1{
        margin: 0.5em auto;
        height: 95%;
        position: relative;
        font-size: 30px;
        line-height: 12px;
        color: #FFF;


    }
.container h1 em{
        font-size: 5px;
        margin: auto;
    }


.container h1 {
    margin: 0.5em auto;
    color: #FFF;
    display: inline-block ;
}
.container h6 {
    display: inline-block;
    margin: 0.5em auto;
    color: #F2F;
}



{#like content#}

.container .chatbox {
    background: rgba(255, 255, 255, 0.05);
    width: 950px;
    height: 90%;
    bottom:0;
    border-radius: 0.2em;
    box-shadow: 1px 1px 12px rgba(0, 0, 0, 0.1);
    float:left;
    {#overflow: hidden;#}
    position: relative;
}

.container .chatbox  p {

    font-size: 1em;
    font-weight: 300;
    color: #FFF;
    max-width: 60%;
    float: right;

}
.container.chatbox {
  float: left;
}

.container .chatbox .messages {
  height: auto;
  min-height: calc(100% - 93px);
  max-height: calc(100% - 93px);
  overflow-y: scroll;
  overflow-x: hidden;
}

.container .chatbox .messages::-webkit-scrollbar {
  width: 8px;
  background: transparent;
}
.container .chatbox .messages::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.1);
}
.container .chatbox .messages  li {
  display: inline-block;
  clear: both;
  float: left;
  margin: 15px 15px 5px 15px;
  width: calc(100% - 25px);
  font-size: 0.9em;
}
.container .chatbox .messages  li:nth-last-child(1) {
  margin-bottom: 20px;
}
.container .chatbox .messages  li.sent img {
  margin: 6px 8px 0 0;
}
.container .chatbox .messages  li.sent p {
  {#background: #435f7a;#}
  {#color: #f5f5f5;#}
    background: rgba(255, 255, 255, 0.2);
    padding: 0.3em 1em;
    border-radius:6px;
}
.container .chatbox .messages  li.replies img {
  float: right;
  margin: 6px 0 0 8px;
}
.container .chatbox .messages  li.replies p {
  {#background: #f5f5f5;#}
  {#float: right;#}
    background: rgba(255, 255, 255, 0.2);
    float: left;
    padding: 0.3em 1em;
    border-radius:6px;
}
.container .chatbox .messages  li img {
  width: 22px;
  border-radius: 50%;
  float: left;
}
.container .chatbox .messages ul li p {
  display: inline-block;
  padding: 10px 15px;
  border-radius: 20px;
  max-width: 205px;
  line-height: 130%;
}




{#////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////#}









.chatbox__user-list {
  background: rgba(255, 255, 255, 0.1);
  width: 25%;
  height: 100%;
  float: right;
  border-top-right-radius: 0.2em;
  border-bottom-right-radius: 0.2em;
}


.chatbox__user, .chatbox__user--active, .chatbox__user--busy, .chatbox__user--away {
  width: 0.5em;
  height: 0.5em;
  border-radius: 100%;
  margin: 1em 1em;
}

.chatbox__user--active {
  background: rgba(23, 190, 187, 0.8);
}

.chatbox__user--busy {
  background: rgba(252, 100, 113, 0.8);
}

.chatbox__user--away {
  background: rgba(255, 253, 130, 0.8);
}



.chatbox form {
  background: #222;
}

.chatbox form textarea {
  background: rgba(255, 255, 255, 0.03);
  position: absolute;
  bottom: 0;
  left: 0;
  border: none;
  width: 75%;
  padding: 1.2em;
  outline: none;
  color: rgba(255, 255, 255, 0.9);
  font-weight: 300;
}


::-webkit-input-placeholder {
  color: rgba(255, 255, 255, 0.9);
}

:-moz-placeholder {
  color: rgba(255, 255, 255, 0.9);
}

::-moz-placeholder {
  color: rgba(255, 255, 255, 0.9);
}

:-ms-input-placeholder {
  color: rgba(255, 255, 255, 0.9);
}

.sidenav {
    height: 100%;
    width: 0;
    position: fixed;
    z-index: 1;
    top: 0;
    right: 0;
    background: linear-gradient(15deg, #997D37 ,#2a7561,#18594B,#115146 );
    opacity: 0.7;
    overflow-x: hidden;
    transition: 0.5s;
    padding-top: 60px;
}

.sidenav a {
    padding: 8px 8px 8px 32px;
    text-decoration: none;
    font-size: 15px;
    color: rgba(200,200,200,0.9);
    display: block;
    transition: 0.3s;
}

.sidenav a:hover {
    color: #f1f1f1;
}

.sidenav .closebtn {
    position: absolute;
    top: 0;
    right: 25px;
    font-size: 30px;
    margin-left: 50px;
}

.btn-change{
    font-size:15px;
    display:table;
    padding-left: auto;
    color: rgba(200,200,200,0.9);
    background-color:transparent ;
    width:140px;height:40px;
    border:2px blue none;
}
.btn-change:hover{
  color: #f1f1f1;
}


.btn-for-list{
    color: rgba(200,200,200,0.9);
    background-color:transparent ;
    border: none;
    height:13px;
    float: left;
    text-align: left;
    margin: -0.25em 2em;
    font-size: 1em;
    font-weight: 300;


}
.btn-for-list:hover{
  color: #f1f1f1;
}



/* Style the list items */
ul li {
  cursor: pointer;
  position: relative;
  padding: 12px 8px 12px 40px;
  list-style-type: none;
  background: #eee;
  font-size: 18px;
  transition: 0.2s;
    /* make the list items unselectable */
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Set all odd list items to a different color (zebra-stripes) */
ul li:nth-child(odd) {
  background: #f9f9f9;
}
/* Darker background-color on hover */
ul li:hover {
  background: #ddd;
}
/* When clicked on, add a background color and strike out text */
ul li.checked {
  background: #888;
  color: #fff;
  text-decoration: line-through;
}
/* Add a "checked" mark when clicked on */
ul li.checked::before {
  content: '';
  position: absolute;
  border-color: #fff;
  border-style: solid;
  border-width: 0 2px 2px 0;
  top: 10px;
  left: 16px;
  transform: rotate(45deg);
  height: 15px;
  width: 7px;
}
/* Style the close button */
{#拒絕#}
.closeli {
  position: absolute;
  right: 0;
  top: 0;
  padding: 12px 16px 12px 16px;
}
.closeli:hover {
  background-color: #4d0000;
  color: white;
}
{#接受#}
.closeli2 {
  position: absolute;
  right: 48px;
  top: 0;
  padding: 12px 16px 12px 16px ;
}
.closeli2:hover {
  background-color: #0a420a;
  color: white;
}



</style>
    <link rel="shortcut icon" href="">
</head>
<body>
    <span style="font-size:30px;cursor:pointer; float:right;color: #FFF;" onclick="openNav()">&#9776; &nbsp;</span>
    <div id="mySidenav" class="sidenav">
          <a  href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
          <button  class=" btn-change">Information
          </button>
            <br>
          <button  class=" btn-change" data-toggle="modal" data-target="#myModal" >Add Friend
          </button>
            <br>
          <button  class=" btn-change" data-toggle="modal" data-target="#Friend_Request" id ='Request' >Friend Request
          </button>
            <br>
          <button  class=" btn-change">Social Network
          </button>
            <br>
          <button  class=" btn-change">Email
          </button>
            <br>
          <button  class=" btn-change ">SMS Message
          </button>
            <br>
          <form action="" method="POST"  >
                {% csrf_token %}
              <button type= 'submit' class="btn-change"  value="logout" name="logout">Logout
              </button>
          </form>

    </div>
    <!-----  Add Friend Modal對話匡 --------->
      <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog modal-sm">
          <div class="modal-content">
            <div class="modal-header">
              <button id = "close" type="button" class="close" data-dismiss="modal"> &times;</button>
              <h4 class="modal-title"> Add Friend </h4>
                <div class="modal-body">
                        Personal_id: <input type="text" id="fpid" name="fpid" class = modalinline>

                        <button id ="search" type="button"  class="btn btn-primary">Search </button>
                </div>
                <div class="modal-body">
                           Search Result:
                    <div id ="log" style="position: absolute"> </div>
                        <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <button id ="add" type="button" style=" background-color: #0a420a;
                                                            border: none;
                                                            color: white;
                                                            padding: 5px 8px;
                                                            text-align: center;
                                                            text-decoration: none;
                                                            display: none;
                                                            font-size: 12px;
                                                            cursor: pointer;
                                                                          "> O </button>
                    <button id ="cancle" type="button" style=" background-color: #4d0000;
                                                            border: none;
                                                            color: white;
                                                            padding: 5px 8px;
                                                            text-align: center;
                                                            text-decoration: none;
                                                            display: none;
                                                            font-size: 12px;
                                                            cursor: pointer;
                                                                        "> X </button>
                </div>
             </div>
          </div>
        </div>
      </div>


    <!-----  Friend Request Modal對話匡 --------->
     <div class="modal fade" id="Friend_Request" role="dialog">
        <div class="modal-dialog modal-sm">
          <div class="modal-content">
            <div class="modal-header">
              <button id = "close2" type="button" class="close" data-dismiss="modal"> &times;</button>
              <h4 class="modal-title"> Friend Request </h4>
                <div class="modal-body">
                    <ul>
                        <li id="people"></li>
                    </ul>
                </div>

             </div>
          </div>
        </div>
      </div>





<!------------  Script 專區 -------------->
    <script>

    {#<!------- Side bar ----->#}
        function openNav() {
            document.getElementById("mySidenav").style.width = "160px";
            document.body.style.backgroundColor = "rgba(0,0,0,0.4)";
        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
            document.body.style.backgroundColor = "white";
        }

    {#<!------- Modal功能應用區  ----->#}
        $(document).ready(function(){
             $.ajaxSetup({ data: {csrfmiddlewaretoken: '{{ csrf_token }}' }, });
        });

        $(document).on('hidden.bs.modal', function () {
          $('.modal-body input,.modal-body textarea').each(function(){
              $(this).val('');
              $('#log').empty();
              $('#add').hide();
              $('#cancle').hide();
          });
        });
        {#<!------- Add Friend request ----->#}
        $("#search").click( function (event) {
            idvalue = $('#fpid').val();
            event.preventDefault();
            $('#log').empty();
            $.ajax({
                 url:'/dna/main/',
                 type:'POST',
                 dataType: "json",
                 data: {
                     'idvalue':idvalue,},
                {#------  result is from views.py 的資料  ------#}
                 success: function(result) {
                     if (result.ans543 == "No User Exist"){
                         $("<div>").append(result.ans543).appendTo("#log");
                         $('#add').hide();
                         $('#cancle').hide();

                     }
                     else if(result.ans543 == "You Already Added !!"){
                         $("<div>").append(result.ans543).appendTo("#log");
                         $('#add').hide();
                         $('#cancle').hide();
                     }
                     else{
                         $("<div>").append(result.ans543).appendTo("#log");
                         $('#add').show();
                         $('#cancle').show();
                         $('#cancle').click(function(){
                             $('#log').empty();
                         });
                     }
                 },
                 fail: function() {
                 }
            });
        });
        $("#add").click( function () {
            yes_to_add = 1;
            idvalue = $('#fpid').val();
            $.ajax({
                 url:'/dna/main_for_ajax/',
                 type:'POST',
                 dataType: "json",
                 data: {
                     'yes_to_add':yes_to_add ,
                     'idvalue':idvalue,
                 },
                 success: function() {
                     alert('Sent Request');
                 },
                 fail: function() {
                 }
            })
        });

         {#<!------- Friend Request ----->#}
          $("#Request").click( function (result) {
              $('#people').empty();

              $.ajax({
                  url: '/dna/show_request/',
                  type: 'POST',
                  dataType: "json",
                  data: result.dic,
                  success: function (data) {
                      for (ii in data) {
                          $('<li>').append(data[ii]).appendTo("#people");
                      }
                  // Create a "closeli" button and append it to each list item
                      myNodelist = document.getElementsByTagName("li");
                      myNodelist2 = document.getElementsByTagName("li");
                      for (i = 1; i < myNodelist.length; i++) {            // 待解決：因為底層還有個#people 所以i=1
                          span = document.createElement("span");
                          txt = document.createTextNode("\u00D7");
                          span.className = "closeli";
                          span.appendChild(txt);
                          span2 = document.createElement("span2");
                          myNodelist[i].appendChild(span);

                          txt2 = document.createTextNode("O");
                          span2.className = "closeli2";
                          span2.appendChild(txt2);
                          myNodelist2[i].appendChild(span2);
                      }
                 // Click on a close button to hide the current list item
                    // 拒絕：
                      closeli = document.getElementsByClassName("closeli");
                      for (i = 0; i < closeli.length; i++) {
                          closeli[i].onclick = function() {
                            div = this.parentElement;
                            div.style.display = "none";
                            what_you_click = div.textContent;
                            cry_or_smile = 0;
                            $.ajax({
                                url: '/dna/cry_or_smile/',
                                type: 'POST',
                                dataType: "json",
                                data: {'cry_or_smile':cry_or_smile,
                                       'closeli':what_you_click ,
                                },
                            })
                          };
                        }
                    //接受：
                      closeli2 = document.getElementsByClassName("closeli2");
                      for (i = 0; i < closeli2.length; i++) {
                          closeli2[i].onclick = function() {
                            div = this.parentElement;
                            div.style.display = "none";
                            cry_or_smile = 1;
                            what_you_click = div.textContent;
                             $.ajax({
                                url: '/dna/cry_or_smile/',
                                type: 'POST',
                                dataType: "json",
                                data: {'cry_or_smile':cry_or_smile,
                                        'closeli':what_you_click ,
                                },
                            })
                          }
                        }
                  },
                  fail: function () {
                  }
              });
          });


    </script>
{#        <img src="../../../Shield/img/4.png" style=" width:50px ; float: left; margin:15px " alt="dna">#}
    <div class='container ' ng-cloak ng-app="chatApp" style="position:relative " >
        <h1 id="'ppp" >
            DNA Messenger &nbsp;&nbsp;<em>Personal ID:&nbsp;{{ pid }}</em>
        </h1>
      <div class='chatbox' ng-controller="MessageCtrl as chatMessage">
        <div class='chatbox__user-list'>
            <h6 style="padding-left: 40%; top: 5% "></h6><i class="material-icons" style="font-size:36px;color:white">people</i>
            <div></div>
            {% for i in myfriend %}
            <div  class='chatbox__user--active'>
                 <button ng-click ='myFunc()' class='btn-for-list' type="button" id ='kerker'  value ='{{ i }}'  >{{ i }}</button>
            </div>
            {% endfor %}
        </div>

          <div class="messages">
              <li class="sent"></li>
              <li class="replies"></li>
          </div>

        <form>
            <textarea id="chat-message-input" type="text"  placeholder="Type Message" ></textarea>
        </form>
      </div>


      <script >

          app = angular.module('chatApp', []);
        // {#因為django傳資料也用{{  }},跟angular撞到 ，所以angular要改：#}
          app.config(function($interpolateProvider) {
              $interpolateProvider.startSymbol('[[');
              $interpolateProvider.endSymbol(']]');
          });
          app.controller('MessageCtrl', function($scope) {

              function writeToScreen(message) {
                  $("<li class='sent'>"+"<p>"+message+"</p>"+"</li>").appendTo('.messages');

              }

              function fromothertoScreen(message) {
                  $("<li class ='replies'>"+"<p>"+message+"</p>"+"</li>").appendTo('.messages');}


             $scope.myFunc = function() {
                 fired_button = $('#kerker').val();
                 p_id = $('em').text();
                 p_id2 =p_id.split("Personal ID:\xa0");
                 my_id = p_id2.slice(1);

                 $.ajax({
                     url: '/dna/fire_in_the_hole_for_ajax/',
                     type: 'POST',
                     dataType: "json",
                     data: {'fired_button':fired_button},
                     success: function(result) {
                         {#console.log(result);#}
                         {#room_guys= result;#}
                         count = 0;
                         for ( i=count;i<count+4;i++){
                                     $('.messages').prepend("<li class='sent'>" + "<p>" + result.ls[i] + "</p>" + "</li>");
                                     $('.messages').prepend("<li class='replies'>" + "<p>" + result.lr[i] + "</p>" + "</li>");
                                     {#滑到最底:#}
                                     $('.messages').scrollTop(2000);
                         }
                         count= count+4;
                         $('.messages').scroll(function(){
                             if (count<= result.ls.length){
                                 if ($('.messages').scrollTop() == 0) {
                                     for ( i=count;i<count+4;i++){
                                         $('.messages').prepend("<li class='sent'>" + "<p>" + result.ls[i] + "</p>" + "</li>");
                                         $('.messages').prepend("<li class='replies'>" + "<p>" + result.lr[i] + "</p>" + "</li>");
                                         $('.messages').scrollTop(50);
                                     }
                                     count= count+4
                                 }
                             }

                         });
                     }

                 });

                 chatSocket = new WebSocket('ws://' + window.location.host + '/fire_in_the_hole/' + fired_button+'_'+my_id+ '/');

                 chatSocket.onmessage = function(e) {   // 6. websocket get data from backend then sent to the borwser to let clients see.
                      data = JSON.parse(e.data);
                      messagex = data['messagex'];
                      now_time = data['now_time'];
                      receive_user = data['user'];
                      user = "{{ pu }}";

                      console.log(messagex);
                      console.log('happy');
                      console.log(receive_user);
                      console.log(user);


                      if (receive_user === user) {
                          writeToScreen(messagex);}
                      else{
                          fromothertoScreen(messagex);}
                  };

                 chatSocket.onclose = function(e) {
                       console.error('Chat socket closed unexpectedly');
                 };

                 document.querySelector('#chat-message-input').onkeyup = function(event) {
                     e = event || window.event || arguments.callee.caller.arguments[0];
                     if (e.shiftKey && e.keyCode === 13 )
                        { }
                     else if (e.keyCode === 13) {  // enter, return
                         e.preventDefault();
                         messageInputDom = document.querySelector('#chat-message-input');
                         strContent = document.querySelector('#chat-message-input').value;

                         pattern = new RegExp("[\u4E00-\u9FA5]+"); // 中文
                         pattern2 = new RegExp("[\u3105-\u3129\u02CA\u02C7\u02CB\u02D9]+");  //注音

                        if (strContent.length ===1){

                            if(pattern.test(strContent) || pattern2.test(strContent)){
                             {#alert('字符串 :中文');#}
                             strContent = strContent.replace(/\r\n/g, '<br/>'); //IE9、FF、chrome
                             strContent = strContent.replace(/\n/g, '<br/>'); //IE7-8
                             strContent = strContent.replace(/\s/g, ' '); //空格处理
                             chatSocket.send(JSON.stringify({   // 1. from websocket send to backend (next go to consumers2.py )
                                    'messagex': strContent
                              }));
                             messageInputDom.value = '';
                             $(".messages").stop().animate({ scrollTop: $(".messages")[0].scrollHeight}, 1000);
                            }
                            else{
                                console.log(strContent.length);
                              messageInputDom.value = '';
                            }
                        }
                         else{
                             {#alert("处理前的strContent为\r\n"+strContent);#}
                             strContent = strContent.replace(/\r\n/g, '<br/>'); //IE9、FF、chrome
                             strContent = strContent.replace(/\n/g, '<br/>'); //IE7-8
                             strContent = strContent.replace(/\s/g, ' '); //空格处理
                             chatSocket.send(JSON.stringify({   // 1. from websocket send to backend (next go to consumers2.py )
                                    'messagex': strContent
                              }));
                             messageInputDom.value = '';
                             $(".messages").stop().animate({ scrollTop: $(".messages")[0].scrollHeight}, 1000);
                         }
                      }
                  };






             };
          });
      </script>
    </div>
</body>
</html>